# /opt/webapp/nginx.conf  →  mounted as /etc/nginx/conf.d/default.conf


# Custom log format for edge verification
log_format edge '$remote_addr - $host "$request" '
                'xff="$http_x_forwarded_for" token="$http_x_edge_token"';

server {
  listen 80 default_server;
  server_name _;

  root   /var/www/html;
  index  index.php index.html index.htm;
  access_log /var/log/nginx/access.log edge;

# --- ADD THIS (optional but recommended): allow only reverse proxy IP ---
  allow 172.18.0.4;   # edge-proxy container IP from `docker network inspect`
  deny all;

  # --- ADD THIS (recommended): require the token from edge ---
  if ($http_x_edge_token != "s3cr3t-long-random-string") { return 403; }
 
 # Uploads (match PHP limits in wp-php if you change these)
  client_max_body_size 64m;

  # Basic hardening headers
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;

  # WordPress pretty permalinks
  location / {
    try_files $uri $uri/ /index.php?$args;
  }

  # Serve static assets efficiently (cache in browser)
  location ~* \.(?:jpg|jpeg|gif|png|svg|webp|ico|css|js|map|woff2?|ttf|otf)$ {
    expires 30d;
    add_header Cache-Control "public, no-transform";
    access_log off;
    try_files $uri $uri/ /index.php?$args;
  }

  # PHP → FastCGI (wp-php:9000)
  location ~ \.php$ {
		
    # 404 if the PHP file itself doesn't exist
    try_files $uri =404;
    fastcgi_param HTTP_HOST $host;            # ← Ensure PHP/WordPress sees the real Host
    fastcgi_param HTTPS     $https if_not_empty;  # ← Helps when you add HTTPS later
    include fastcgi_params;                         # provided by the image
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO        $fastcgi_path_info;
    fastcgi_index index.php;
    fastcgi_pass  wp-php:9000;

    # Buffers/timeouts (help under load)
    fastcgi_read_timeout  120s;
    fastcgi_send_timeout  120s;
    fastcgi_buffer_size   32k;
    fastcgi_buffers       8 32k;
  }

  # Never execute PHP from uploads
  location ~* /(?:uploads|files)/.*\.php$ { deny all; }

  # Deny sensitive files
  location ~* ^/(?:\.|wp-config\.php|composer\.(json|lock)|readme\.html|license\.txt) { deny all; }
  location ~* \.(?:ini|log|sh|sql|bak|config|env)$ { deny all; }
  location ~ /\.ht { deny all; }  # .htaccess is for Apache; keep it hidden

  # Housekeeping
  location = /favicon.ico { log_not_found off; access_log off; }
  location = /robots.txt  { allow all;       log_not_found off; access_log off; }
}
